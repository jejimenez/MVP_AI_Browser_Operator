============================= test session starts ==============================
platform darwin -- Python 3.12.0, pytest-8.2.0, pluggy-1.5.0 -- /Users/jaimeenrrique/.pyenv/versions/3.12.0/envs/WebTesterAgent/bin/python
cachedir: .pytest_cache
rootdir: /Users/jaimeenrrique/Automation/WebOperatorFromTC
configfile: pytest.ini
plugins: cov-5.0.0, anyio-4.9.0, asyncio-0.23.6, mock-3.14.0
asyncio: mode=Mode.AUTO
collecting ... collected 9 items / 8 deselected / 1 selected

tests/integration/test_operator_runner.py::TestOperatorRunnerIntegration::test_google_search_flow 
-------------------------------- live log setup --------------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: KqueueSelector
DEBUG    asyncio:selector_events.py:64 Using selector: KqueueSelector
INFO     app.infrastructure.ai_client:ai_client.py:158 Successfully initialized Gemini API client with model: gemini-2.0-flash
INFO     app.infrastructure.ai_client:ai_client.py:158 Successfully initialized Gemini API client with model: gemini-2.0-flash
-------------------------------- live log call ---------------------------------
INFO     app.services.operator_runner:operator_runner.py:124 Generating structured Gherkin steps from natural language
DEBUG    app.infrastructure.ai_generators:ai_generators.py:62 NLToGherkinGenerator Prompt: # app/prompts/nl_to_gherkin.txt
You are an expert test automation assistant.

Given the following natural language test description, generate a list of test steps as a JSON array. 
Each item should have:
- gherkin: the Gherkin step as text (e.g., "When I click the login button")
- action: the type of action (e.g., "click", "input", "navigate", "wait", "verify")
- target: the UI element or page being acted upon
- value: the value to be used for input actions, or null if not applicable

Test Description:
Navigate to google
Search for python
Click on the first result

Output only the JSON array, no explanations.
DEBUG    app.infrastructure.ai_client:ai_client.py:212 Sending prompt to Gemini API: https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent
DEBUG    urllib3.connectionpool:connectionpool.py:1049 Starting new HTTPS connection (1): generativelanguage.googleapis.com:443
DEBUG    urllib3.connectionpool:connectionpool.py:544 https://generativelanguage.googleapis.com:443 "POST /v1beta/models/gemini-2.0-flash:generateContent HTTP/1.1" 200 None
DEBUG    app.infrastructure.ai_client:ai_client.py:217 Received response from Gemini API: {'candidates': [{'content': {'parts': [{'text': '```json\n[\n  {\n    "gherkin": "Given I navigate to google",\n    "action": "navigate",\n    "target": "google",\n    "value": null\n  },\n  {\n    "gherkin": "When I search for python",\n    "action": "input",\n    "target": "search box",\n    "value": "python"\n  },\n  {\n    "gherkin": "Then I click on the first result",\n    "action": "click",\n    "target": "first result",\n    "value": null\n  }\n]\n```'}], 'role': 'model'}, 'finishReason': 'STOP', 'safetyRatings': [{'category': 'HARM_CATEGORY_HATE_SPEECH', 'probability': 'NEGLIGIBLE'}, {'category': 'HARM_CATEGORY_DANGEROUS_CONTENT', 'probability': 'NEGLIGIBLE'}, {'category': 'HARM_CATEGORY_HARASSMENT', 'probability': 'NEGLIGIBLE'}, {'category': 'HARM_CATEGORY_SEXUALLY_EXPLICIT', 'probability': 'NEGLIGIBLE'}], 'avgLogprobs': -0.013026346255392923}], 'usageMetadata': {'promptTokenCount': 161, 'candidatesTokenCount': 137, 'totalTokenCount': 298, 'promptTokensDetails': [{'modality': 'TEXT', 'tokenCount': 161}], 'candidatesTokensDetails': [{'modality': 'TEXT', 'tokenCount': 137}]}, 'modelVersion': 'gemini-2.0-flash'}
DEBUG    app.infrastructure.ai_generators:ai_generators.py:68 NLToGherkinGenerator Response: ```json
[
  {
    "gherkin": "Given I navigate to google",
    "action": "navigate",
    "target": "google",
    "value": null
  },
  {
    "gherkin": "When I search for python",
    "action": "input",
    "target": "search box",
    "value": "python"
  },
  {
    "gherkin": "Then I click on the first result",
    "action": "click",
    "target": "first result",
    "value": null
  }
]
```
DEBUG    app.infrastructure.ai_generators:ai_generators.py:71 NLToGherkinGenerator clean_content: [
  {
    "gherkin": "Given I navigate to google",
    "action": "navigate",
    "target": "google",
    "value": null
  },
  {
    "gherkin": "When I search for python",
    "action": "input",
    "target": "search box",
    "value": "python"
  },
  {
    "gherkin": "Then I click on the first result",
    "action": "click",
    "target": "first result",
    "value": null
  }
]
DEBUG    app.services.operator_runner:operator_runner.py:84 Creating browser manager
DEBUG    app.services.operator_runner:operator_runner.py:86 Starting browser
INFO     app.services.operator_runner:operator_runner.py:89 Browser initialized successfully
INFO     app.services.operator_runner:operator_runner.py:136 Navigating to URL: https://www.google.com
DEBUG    app.services.operator_runner:operator_runner.py:142 Navigation attempt 1/3
DEBUG    app.infrastructure.playwright_manager:playwright_manager.py:258 Executing instruction: goto('https://www.google.com', wait_until='networkidle')
WARNING  app.infrastructure.playwright_manager:playwright_manager.py:286 Additional waiting failed: Page.wait_for_selector: Timeout 10000ms exceeded.
Call log:
waiting for locator("input[name=\"q\"]") to be visible

DEBUG    app.infrastructure.playwright_manager:playwright_manager.py:258 Executing instruction: url()
DEBUG    app.infrastructure.playwright_manager:playwright_manager.py:258 Executing instruction: wait_for_load_state('networkidle')
DEBUG    app.infrastructure.playwright_manager:playwright_manager.py:258 Executing instruction: wait_for_load_state('networkidle', timeout=500)
DEBUG    app.infrastructure.playwright_manager:playwright_manager.py:258 Executing instruction: wait_for_load_state('domcontentloaded')
INFO     app.services.operator_runner:operator_runner.py:173 Successfully navigated to https://www.google.com/
INFO     app.services.operator_runner:operator_runner.py:194 Executing step 1/3: Given I navigate to google
DEBUG    app.services.operator_runner:operator_runner.py:272 Training data saved to 'snapshot_json.jsonl'
DEBUG    app.infrastructure.ai_client:ai_client.py:212 Sending prompt to Gemini API: https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent
DEBUG    urllib3.connectionpool:connectionpool.py:1049 Starting new HTTPS connection (1): generativelanguage.googleapis.com:443
DEBUG    urllib3.connectionpool:connectionpool.py:544 https://generativelanguage.googleapis.com:443 "POST /v1beta/models/gemini-2.0-flash:generateContent HTTP/1.1" 200 None
DEBUG    app.infrastructure.ai_client:ai_client.py:217 Received response from Gemini API: {'candidates': [{'content': {'parts': [{'text': '```json\n{\n  "high_precision": [\n    "goto(\'https://www.google.com\', wait_until=\'networkidle\')"\n  ],\n  "low_precision": [\n    "goto(\'https://www.google.com\')"\n  ]\n}\n```'}], 'role': 'model'}, 'finishReason': 'STOP', 'safetyRatings': [{'category': 'HARM_CATEGORY_HATE_SPEECH', 'probability': 'NEGLIGIBLE'}, {'category': 'HARM_CATEGORY_DANGEROUS_CONTENT', 'probability': 'NEGLIGIBLE'}, {'category': 'HARM_CATEGORY_HARASSMENT', 'probability': 'NEGLIGIBLE'}, {'category': 'HARM_CATEGORY_SEXUALLY_EXPLICIT', 'probability': 'NEGLIGIBLE'}], 'avgLogprobs': -0.0006096030748079694}], 'usageMetadata': {'promptTokenCount': 52222, 'candidatesTokenCount': 63, 'totalTokenCount': 52285, 'promptTokensDetails': [{'modality': 'TEXT', 'tokenCount': 52222}], 'candidatesTokensDetails': [{'modality': 'TEXT', 'tokenCount': 63}]}, 'modelVersion': 'gemini-2.0-flash'}
DEBUG    app.infrastructure.ai_generators:ai_generators.py:164 Response PlaywrightGenerator: AIResponse(content='```json\n{\n  "high_precision": [\n    "goto(\'https://www.google.com\', wait_until=\'networkidle\')"\n  ],\n  "low_precision": [\n    "goto(\'https://www.google.com\')"\n  ]\n}\n```', metadata={'model': 'gemini-2.0-flash', 'raw_response': {'candidates': [{'content': {'parts': [{'text': '```json\n{\n  "high_precision": [\n    "goto(\'https://www.google.com\', wait_until=\'networkidle\')"\n  ],\n  "low_precision": [\n    "goto(\'https://www.google.com\')"\n  ]\n}\n```'}], 'role': 'model'}, 'finishReason': 'STOP', 'safetyRatings': [{'category': 'HARM_CATEGORY_HATE_SPEECH', 'probability': 'NEGLIGIBLE'}, {'category': 'HARM_CATEGORY_DANGEROUS_CONTENT', 'probability': 'NEGLIGIBLE'}, {'category': 'HARM_CATEGORY_HARASSMENT', 'probability': 'NEGLIGIBLE'}, {'category': 'HARM_CATEGORY_SEXUALLY_EXPLICIT', 'probability': 'NEGLIGIBLE'}], 'avgLogprobs': -0.0006096030748079694}], 'usageMetadata': {'promptTokenCount': 52222, 'candidatesTokenCount': 63, 'totalTokenCount': 52285, 'promptTokensDetails': [{'modality': 'TEXT', 'tokenCount': 52222}], 'candidatesTokensDetails': [{'modality': 'TEXT', 'tokenCount': 63}]}, 'modelVersion': 'gemini-2.0-flash'}})
ERROR    app.infrastructure.ai_generators:ai_generators.py:209 Invalid JSON response: json
{
  "high_precision": [
    "goto('https://www.google.com', wait_until='networkidle')"
  ],
  "low_precision": [
    "goto('https://www.google.com')"
  ]
}
ERROR    app.infrastructure.ai_generators:ai_generators.py:177 AI client error during instruction generation: Invalid Playwright instruction format
ERROR    app.services.operator_runner:operator_runner.py:367 Step execution failed: cannot access local variable 'instruction_json' where it is not associated with a value
Traceback (most recent call last):
  File "/Users/jaimeenrrique/Automation/WebOperatorFromTC/app/infrastructure/ai_generators.py", line 170, in generate_instruction
    raise StepGenerationException("Invalid Playwright instruction format")
app.domain.exceptions.StepGenerationException: Invalid Playwright instruction format

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/jaimeenrrique/Automation/WebOperatorFromTC/app/services/operator_runner.py", line 279, in _execute_single_step
    instruction_json = await self.playwright_generator.generate_instruction(
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jaimeenrrique/Automation/WebOperatorFromTC/app/infrastructure/ai_generators.py", line 178, in generate_instruction
    raise StepGenerationException(f"AI client error: {str(e)}") from e
app.domain.exceptions.StepGenerationException: AI client error: Invalid Playwright instruction format

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/jaimeenrrique/Automation/WebOperatorFromTC/app/services/operator_runner.py", line 345, in _execute_single_step
    playwright_instruction=instruction_json,  # Store the raw JSON for debugging
                           ^^^^^^^^^^^^^^^^
UnboundLocalError: cannot access local variable 'instruction_json' where it is not associated with a value
DEBUG    app.services.operator_runner:operator_runner.py:100 Stopping browser
DEBUG    app.services.operator_runner:operator_runner.py:107 Browser cleanup completed
FAILED                                                                   [100%]
------------------------------ live log teardown -------------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: KqueueSelector


=================================== FAILURES ===================================
____________ TestOperatorRunnerIntegration.test_google_search_flow _____________

self = <test_operator_runner.TestOperatorRunnerIntegration object at 0x11ffa44a0>
runner = <app.services.operator_runner.OperatorRunnerService object at 0x11ff0ffe0>

    @pytest.mark.asyncio
    async def test_google_search_flow(self, runner):
        # Natural language steps describing the test scenario
        nl_steps = (
            "Navigate to google\n"
            "Search for python\n"
            "Click on the first result"
        )
    
        # Run the operator case starting at Google's homepage
        result = await runner.run_operator_case(
            url="https://www.google.com",
            natural_language_steps=nl_steps
        )
    
        # Assert overall success
>       assert result.success, f"Operator run failed: {result.error_message}"
E       AssertionError: Operator run failed: Step execution failed: cannot access local variable 'instruction_json' where it is not associated with a value
E       assert False
E        +  where False = OperatorCaseResult(success=False, steps_results=[], start_time=datetime.datetime(2025, 4, 27, 11, 26, 35, 87094), end_time=datetime.datetime(2025, 4, 27, 11, 27, 3, 101057), total_duration=28.013963, error_message="Step execution failed: cannot access local variable 'instruction_json' where it is not associated with a value", metadata={'request_id': '56984310-70d6-42cd-a424-4b22c9f52527'}).success

tests/integration/test_operator_runner.py:182: AssertionError
---------------------------- Captured stdout setup -----------------------------
[2025-04-27 11:26:35] [INFO] [app.infrastructure.ai_client] Successfully initialized Gemini API client with model: gemini-2.0-flash
[2025-04-27 11:26:35] [INFO] [app.infrastructure.ai_client] Successfully initialized Gemini API client with model: gemini-2.0-flash
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: KqueueSelector
DEBUG    asyncio:selector_events.py:64 Using selector: KqueueSelector
INFO     app.infrastructure.ai_client:ai_client.py:158 Successfully initialized Gemini API client with model: gemini-2.0-flash
INFO     app.infrastructure.ai_client:ai_client.py:158 Successfully initialized Gemini API client with model: gemini-2.0-flash
----------------------------- Captured stdout call -----------------------------
[2025-04-27 11:26:35] [INFO] [app.services.operator_runner] Generating structured Gherkin steps from natural language
[2025-04-27 11:26:35] [DEBUG] [app.infrastructure.ai_generators] NLToGherkinGenerator Prompt: # app/prompts/nl_to_gherkin.txt
You are an expert test automation assistant.

Given the following natural language test description, generate a list of test steps as a JSON array. 
Each item should have:
- gherkin: the Gherkin step as text (e.g., "When I click the login button")
- action: the type of action (e.g., "click", "input", "navigate", "wait", "verify")
- target: the UI element or page being acted upon
- value: the value to be used for input actions, or null if not applicable

Test Description:
Navigate to google
Search for python
Click on the first result

Output only the JSON array, no explanations.
[2025-04-27 11:26:35] [DEBUG] [app.infrastructure.ai_client] Sending prompt to Gemini API: https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent
[2025-04-27 11:26:36] [DEBUG] [app.infrastructure.ai_client] Received response from Gemini API: {'candidates': [{'content': {'parts': [{'text': '```json\n[\n  {\n    "gherkin": "Given I navigate to google",\n    "action": "navigate",\n    "target": "google",\n    "value": null\n  },\n  {\n    "gherkin": "When I search for python",\n    "action": "input",\n    "target": "search box",\n    "value": "python"\n  },\n  {\n    "gherkin": "Then I click on the first result",\n    "action": "click",\n    "target": "first result",\n    "value": null\n  }\n]\n```'}], 'role': 'model'}, 'finishReason': 'STOP', 'safetyRatings': [{'category': 'HARM_CATEGORY_HATE_SPEECH', 'probability': 'NEGLIGIBLE'}, {'category': 'HARM_CATEGORY_DANGEROUS_CONTENT', 'probability': 'NEGLIGIBLE'}, {'category': 'HARM_CATEGORY_HARASSMENT', 'probability': 'NEGLIGIBLE'}, {'category': 'HARM_CATEGORY_SEXUALLY_EXPLICIT', 'probability': 'NEGLIGIBLE'}], 'avgLogprobs': -0.013026346255392923}], 'usageMetadata': {'promptTokenCount': 161, 'candidatesTokenCount': 137, 'totalTokenCount': 298, 'promptTokensDetails': [{'modality': 'TEXT', 'tokenCount': 161}], 'candidatesTokensDetails': [{'modality': 'TEXT', 'tokenCount': 137}]}, 'modelVersion': 'gemini-2.0-flash'}
[2025-04-27 11:26:36] [DEBUG] [app.infrastructure.ai_generators] NLToGherkinGenerator Response: ```json
[
  {
    "gherkin": "Given I navigate to google",
    "action": "navigate",
    "target": "google",
    "value": null
  },
  {
    "gherkin": "When I search for python",
    "action": "input",
    "target": "search box",
    "value": "python"
  },
  {
    "gherkin": "Then I click on the first result",
    "action": "click",
    "target": "first result",
    "value": null
  }
]
```
[2025-04-27 11:26:36] [DEBUG] [app.infrastructure.ai_generators] NLToGherkinGenerator clean_content: [
  {
    "gherkin": "Given I navigate to google",
    "action": "navigate",
    "target": "google",
    "value": null
  },
  {
    "gherkin": "When I search for python",
    "action": "input",
    "target": "search box",
    "value": "python"
  },
  {
    "gherkin": "Then I click on the first result",
    "action": "click",
    "target": "first result",
    "value": null
  }
]

Validating response: [
  {
    "gherkin": "Given I navigate to google",
    "action": "navigate",
    "target": "google",
    "value": null
  },
  {
    "gherkin": "When I search for python",
    "action": "input",
    "target": "search box",
    "value": "python"
  },
  {
    "gherkin": "Then I click on the first result",
    "action": "click",
    "target": "first result",
    "value": null
  }
]
Response type: <class 'str'>
Parsed JSON: [{'gherkin': 'Given I navigate to google', 'action': 'navigate', 'target': 'google', 'value': None}, {'gherkin': 'When I search for python', 'action': 'input', 'target': 'search box', 'value': 'python'}, {'gherkin': 'Then I click on the first result', 'action': 'click', 'target': 'first result', 'value': None}]
JSON type: <class 'list'>
Validating step: {'gherkin': 'Given I navigate to google', 'action': 'navigate', 'target': 'google', 'value': None}
Current fields: {'value', 'target', 'action', 'gherkin'}
Required fields: {'target', 'action', 'gherkin'}
Validating step: {'gherkin': 'When I search for python', 'action': 'input', 'target': 'search box', 'value': 'python'}
Current fields: {'value', 'target', 'action', 'gherkin'}
Required fields: {'target', 'action', 'gherkin'}
Validating step: {'gherkin': 'Then I click on the first result', 'action': 'click', 'target': 'first result', 'value': None}
Current fields: {'value', 'target', 'action', 'gherkin'}
Required fields: {'target', 'action', 'gherkin'}
[2025-04-27 11:26:36] [DEBUG] [app.services.operator_runner] Creating browser manager
[2025-04-27 11:26:36] [DEBUG] [app.services.operator_runner] Starting browser
[2025-04-27 11:26:40] [INFO] [app.services.operator_runner] Browser initialized successfully
[2025-04-27 11:26:40] [INFO] [app.services.operator_runner] Navigating to URL: https://www.google.com
[2025-04-27 11:26:40] [DEBUG] [app.services.operator_runner] Navigation attempt 1/3
[2025-04-27 11:26:40] [DEBUG] [app.infrastructure.playwright_manager] Executing instruction: goto('https://www.google.com', wait_until='networkidle')
[2025-04-27 11:26:55] [WARNING] [app.infrastructure.playwright_manager] Additional waiting failed: Page.wait_for_selector: Timeout 10000ms exceeded.
Call log:
waiting for locator("input[name=\"q\"]") to be visible

[2025-04-27 11:26:55] [DEBUG] [app.infrastructure.playwright_manager] Executing instruction: url()
[2025-04-27 11:26:55] [DEBUG] [app.infrastructure.playwright_manager] Executing instruction: wait_for_load_state('networkidle')
[2025-04-27 11:26:55] [DEBUG] [app.infrastructure.playwright_manager] Executing instruction: wait_for_load_state('networkidle', timeout=500)
[2025-04-27 11:26:56] [DEBUG] [app.infrastructure.playwright_manager] Executing instruction: wait_for_load_state('domcontentloaded')
[2025-04-27 11:26:56] [INFO] [app.services.operator_runner] Successfully navigated to https://www.google.com/
[2025-04-27 11:26:56] [INFO] [app.services.operator_runner] Executing step 1/3: Given I navigate to google
[2025-04-27 11:26:56] [DEBUG] [app.services.operator_runner] Training data saved to 'snapshot_json.jsonl'
[2025-04-27 11:26:56] [DEBUG] [app.infrastructure.ai_client] Sending prompt to Gemini API: https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent
[2025-04-27 11:27:02] [DEBUG] [app.infrastructure.ai_client] Received response from Gemini API: {'candidates': [{'content': {'parts': [{'text': '```json\n{\n  "high_precision": [\n    "goto(\'https://www.google.com\', wait_until=\'networkidle\')"\n  ],\n  "low_precision": [\n    "goto(\'https://www.google.com\')"\n  ]\n}\n```'}], 'role': 'model'}, 'finishReason': 'STOP', 'safetyRatings': [{'category': 'HARM_CATEGORY_HATE_SPEECH', 'probability': 'NEGLIGIBLE'}, {'category': 'HARM_CATEGORY_DANGEROUS_CONTENT', 'probability': 'NEGLIGIBLE'}, {'category': 'HARM_CATEGORY_HARASSMENT', 'probability': 'NEGLIGIBLE'}, {'category': 'HARM_CATEGORY_SEXUALLY_EXPLICIT', 'probability': 'NEGLIGIBLE'}], 'avgLogprobs': -0.0006096030748079694}], 'usageMetadata': {'promptTokenCount': 52222, 'candidatesTokenCount': 63, 'totalTokenCount': 52285, 'promptTokensDetails': [{'modality': 'TEXT', 'tokenCount': 52222}], 'candidatesTokensDetails': [{'modality': 'TEXT', 'tokenCount': 63}]}, 'modelVersion': 'gemini-2.0-flash'}
[2025-04-27 11:27:02] [DEBUG] [app.infrastructure.ai_generators] Response PlaywrightGenerator: AIResponse(content='```json\n{\n  "high_precision": [\n    "goto(\'https://www.google.com\', wait_until=\'networkidle\')"\n  ],\n  "low_precision": [\n    "goto(\'https://www.google.com\')"\n  ]\n}\n```', metadata={'model': 'gemini-2.0-flash', 'raw_response': {'candidates': [{'content': {'parts': [{'text': '```json\n{\n  "high_precision": [\n    "goto(\'https://www.google.com\', wait_until=\'networkidle\')"\n  ],\n  "low_precision": [\n    "goto(\'https://www.google.com\')"\n  ]\n}\n```'}], 'role': 'model'}, 'finishReason': 'STOP', 'safetyRatings': [{'category': 'HARM_CATEGORY_HATE_SPEECH', 'probability': 'NEGLIGIBLE'}, {'category': 'HARM_CATEGORY_DANGEROUS_CONTENT', 'probability': 'NEGLIGIBLE'}, {'category': 'HARM_CATEGORY_HARASSMENT', 'probability': 'NEGLIGIBLE'}, {'category': 'HARM_CATEGORY_SEXUALLY_EXPLICIT', 'probability': 'NEGLIGIBLE'}], 'avgLogprobs': -0.0006096030748079694}], 'usageMetadata': {'promptTokenCount': 52222, 'candidatesTokenCount': 63, 'totalTokenCount': 52285, 'promptTokensDetails': [{'modality': 'TEXT', 'tokenCount': 52222}], 'candidatesTokensDetails': [{'modality': 'TEXT', 'tokenCount': 63}]}, 'modelVersion': 'gemini-2.0-flash'}})
[2025-04-27 11:27:02] [ERROR] [app.infrastructure.ai_generators] Invalid JSON response: json
{
  "high_precision": [
    "goto('https://www.google.com', wait_until='networkidle')"
  ],
  "low_precision": [
    "goto('https://www.google.com')"
  ]
}
[2025-04-27 11:27:02] [ERROR] [app.infrastructure.ai_generators] AI client error during instruction generation: Invalid Playwright instruction format
[2025-04-27 11:27:02] [ERROR] [app.services.operator_runner] Step execution failed: cannot access local variable 'instruction_json' where it is not associated with a value
Traceback (most recent call last):
  File "/Users/jaimeenrrique/Automation/WebOperatorFromTC/app/infrastructure/ai_generators.py", line 170, in generate_instruction
    raise StepGenerationException("Invalid Playwright instruction format")
app.domain.exceptions.StepGenerationException: Invalid Playwright instruction format

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/jaimeenrrique/Automation/WebOperatorFromTC/app/services/operator_runner.py", line 279, in _execute_single_step
    instruction_json = await self.playwright_generator.generate_instruction(
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jaimeenrrique/Automation/WebOperatorFromTC/app/infrastructure/ai_generators.py", line 178, in generate_instruction
    raise StepGenerationException(f"AI client error: {str(e)}") from e
app.domain.exceptions.StepGenerationException: AI client error: Invalid Playwright instruction format

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/jaimeenrrique/Automation/WebOperatorFromTC/app/services/operator_runner.py", line 345, in _execute_single_step
    playwright_instruction=instruction_json,  # Store the raw JSON for debugging
                           ^^^^^^^^^^^^^^^^
UnboundLocalError: cannot access local variable 'instruction_json' where it is not associated with a value
[2025-04-27 11:27:02] [DEBUG] [app.services.operator_runner] Stopping browser
[2025-04-27 11:27:03] [DEBUG] [app.services.operator_runner] Browser cleanup completed
------------------------------ Captured log call -------------------------------
INFO     app.services.operator_runner:operator_runner.py:124 Generating structured Gherkin steps from natural language
DEBUG    app.infrastructure.ai_generators:ai_generators.py:62 NLToGherkinGenerator Prompt: # app/prompts/nl_to_gherkin.txt
You are an expert test automation assistant.

Given the following natural language test description, generate a list of test steps as a JSON array. 
Each item should have:
- gherkin: the Gherkin step as text (e.g., "When I click the login button")
- action: the type of action (e.g., "click", "input", "navigate", "wait", "verify")
- target: the UI element or page being acted upon
- value: the value to be used for input actions, or null if not applicable

Test Description:
Navigate to google
Search for python
Click on the first result

Output only the JSON array, no explanations.
DEBUG    app.infrastructure.ai_client:ai_client.py:212 Sending prompt to Gemini API: https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent
DEBUG    urllib3.connectionpool:connectionpool.py:1049 Starting new HTTPS connection (1): generativelanguage.googleapis.com:443
DEBUG    urllib3.connectionpool:connectionpool.py:544 https://generativelanguage.googleapis.com:443 "POST /v1beta/models/gemini-2.0-flash:generateContent HTTP/1.1" 200 None
DEBUG    app.infrastructure.ai_client:ai_client.py:217 Received response from Gemini API: {'candidates': [{'content': {'parts': [{'text': '```json\n[\n  {\n    "gherkin": "Given I navigate to google",\n    "action": "navigate",\n    "target": "google",\n    "value": null\n  },\n  {\n    "gherkin": "When I search for python",\n    "action": "input",\n    "target": "search box",\n    "value": "python"\n  },\n  {\n    "gherkin": "Then I click on the first result",\n    "action": "click",\n    "target": "first result",\n    "value": null\n  }\n]\n```'}], 'role': 'model'}, 'finishReason': 'STOP', 'safetyRatings': [{'category': 'HARM_CATEGORY_HATE_SPEECH', 'probability': 'NEGLIGIBLE'}, {'category': 'HARM_CATEGORY_DANGEROUS_CONTENT', 'probability': 'NEGLIGIBLE'}, {'category': 'HARM_CATEGORY_HARASSMENT', 'probability': 'NEGLIGIBLE'}, {'category': 'HARM_CATEGORY_SEXUALLY_EXPLICIT', 'probability': 'NEGLIGIBLE'}], 'avgLogprobs': -0.013026346255392923}], 'usageMetadata': {'promptTokenCount': 161, 'candidatesTokenCount': 137, 'totalTokenCount': 298, 'promptTokensDetails': [{'modality': 'TEXT', 'tokenCount': 161}], 'candidatesTokensDetails': [{'modality': 'TEXT', 'tokenCount': 137}]}, 'modelVersion': 'gemini-2.0-flash'}
DEBUG    app.infrastructure.ai_generators:ai_generators.py:68 NLToGherkinGenerator Response: ```json
[
  {
    "gherkin": "Given I navigate to google",
    "action": "navigate",
    "target": "google",
    "value": null
  },
  {
    "gherkin": "When I search for python",
    "action": "input",
    "target": "search box",
    "value": "python"
  },
  {
    "gherkin": "Then I click on the first result",
    "action": "click",
    "target": "first result",
    "value": null
  }
]
```
DEBUG    app.infrastructure.ai_generators:ai_generators.py:71 NLToGherkinGenerator clean_content: [
  {
    "gherkin": "Given I navigate to google",
    "action": "navigate",
    "target": "google",
    "value": null
  },
  {
    "gherkin": "When I search for python",
    "action": "input",
    "target": "search box",
    "value": "python"
  },
  {
    "gherkin": "Then I click on the first result",
    "action": "click",
    "target": "first result",
    "value": null
  }
]
DEBUG    app.services.operator_runner:operator_runner.py:84 Creating browser manager
DEBUG    app.services.operator_runner:operator_runner.py:86 Starting browser
INFO     app.services.operator_runner:operator_runner.py:89 Browser initialized successfully
INFO     app.services.operator_runner:operator_runner.py:136 Navigating to URL: https://www.google.com
DEBUG    app.services.operator_runner:operator_runner.py:142 Navigation attempt 1/3
DEBUG    app.infrastructure.playwright_manager:playwright_manager.py:258 Executing instruction: goto('https://www.google.com', wait_until='networkidle')
WARNING  app.infrastructure.playwright_manager:playwright_manager.py:286 Additional waiting failed: Page.wait_for_selector: Timeout 10000ms exceeded.
Call log:
waiting for locator("input[name=\"q\"]") to be visible

DEBUG    app.infrastructure.playwright_manager:playwright_manager.py:258 Executing instruction: url()
DEBUG    app.infrastructure.playwright_manager:playwright_manager.py:258 Executing instruction: wait_for_load_state('networkidle')
DEBUG    app.infrastructure.playwright_manager:playwright_manager.py:258 Executing instruction: wait_for_load_state('networkidle', timeout=500)
DEBUG    app.infrastructure.playwright_manager:playwright_manager.py:258 Executing instruction: wait_for_load_state('domcontentloaded')
INFO     app.services.operator_runner:operator_runner.py:173 Successfully navigated to https://www.google.com/
INFO     app.services.operator_runner:operator_runner.py:194 Executing step 1/3: Given I navigate to google
DEBUG    app.services.operator_runner:operator_runner.py:272 Training data saved to 'snapshot_json.jsonl'
DEBUG    app.infrastructure.ai_client:ai_client.py:212 Sending prompt to Gemini API: https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent
DEBUG    urllib3.connectionpool:connectionpool.py:1049 Starting new HTTPS connection (1): generativelanguage.googleapis.com:443
DEBUG    urllib3.connectionpool:connectionpool.py:544 https://generativelanguage.googleapis.com:443 "POST /v1beta/models/gemini-2.0-flash:generateContent HTTP/1.1" 200 None
DEBUG    app.infrastructure.ai_client:ai_client.py:217 Received response from Gemini API: {'candidates': [{'content': {'parts': [{'text': '```json\n{\n  "high_precision": [\n    "goto(\'https://www.google.com\', wait_until=\'networkidle\')"\n  ],\n  "low_precision": [\n    "goto(\'https://www.google.com\')"\n  ]\n}\n```'}], 'role': 'model'}, 'finishReason': 'STOP', 'safetyRatings': [{'category': 'HARM_CATEGORY_HATE_SPEECH', 'probability': 'NEGLIGIBLE'}, {'category': 'HARM_CATEGORY_DANGEROUS_CONTENT', 'probability': 'NEGLIGIBLE'}, {'category': 'HARM_CATEGORY_HARASSMENT', 'probability': 'NEGLIGIBLE'}, {'category': 'HARM_CATEGORY_SEXUALLY_EXPLICIT', 'probability': 'NEGLIGIBLE'}], 'avgLogprobs': -0.0006096030748079694}], 'usageMetadata': {'promptTokenCount': 52222, 'candidatesTokenCount': 63, 'totalTokenCount': 52285, 'promptTokensDetails': [{'modality': 'TEXT', 'tokenCount': 52222}], 'candidatesTokensDetails': [{'modality': 'TEXT', 'tokenCount': 63}]}, 'modelVersion': 'gemini-2.0-flash'}
DEBUG    app.infrastructure.ai_generators:ai_generators.py:164 Response PlaywrightGenerator: AIResponse(content='```json\n{\n  "high_precision": [\n    "goto(\'https://www.google.com\', wait_until=\'networkidle\')"\n  ],\n  "low_precision": [\n    "goto(\'https://www.google.com\')"\n  ]\n}\n```', metadata={'model': 'gemini-2.0-flash', 'raw_response': {'candidates': [{'content': {'parts': [{'text': '```json\n{\n  "high_precision": [\n    "goto(\'https://www.google.com\', wait_until=\'networkidle\')"\n  ],\n  "low_precision": [\n    "goto(\'https://www.google.com\')"\n  ]\n}\n```'}], 'role': 'model'}, 'finishReason': 'STOP', 'safetyRatings': [{'category': 'HARM_CATEGORY_HATE_SPEECH', 'probability': 'NEGLIGIBLE'}, {'category': 'HARM_CATEGORY_DANGEROUS_CONTENT', 'probability': 'NEGLIGIBLE'}, {'category': 'HARM_CATEGORY_HARASSMENT', 'probability': 'NEGLIGIBLE'}, {'category': 'HARM_CATEGORY_SEXUALLY_EXPLICIT', 'probability': 'NEGLIGIBLE'}], 'avgLogprobs': -0.0006096030748079694}], 'usageMetadata': {'promptTokenCount': 52222, 'candidatesTokenCount': 63, 'totalTokenCount': 52285, 'promptTokensDetails': [{'modality': 'TEXT', 'tokenCount': 52222}], 'candidatesTokensDetails': [{'modality': 'TEXT', 'tokenCount': 63}]}, 'modelVersion': 'gemini-2.0-flash'}})
ERROR    app.infrastructure.ai_generators:ai_generators.py:209 Invalid JSON response: json
{
  "high_precision": [
    "goto('https://www.google.com', wait_until='networkidle')"
  ],
  "low_precision": [
    "goto('https://www.google.com')"
  ]
}
ERROR    app.infrastructure.ai_generators:ai_generators.py:177 AI client error during instruction generation: Invalid Playwright instruction format
ERROR    app.services.operator_runner:operator_runner.py:367 Step execution failed: cannot access local variable 'instruction_json' where it is not associated with a value
Traceback (most recent call last):
  File "/Users/jaimeenrrique/Automation/WebOperatorFromTC/app/infrastructure/ai_generators.py", line 170, in generate_instruction
    raise StepGenerationException("Invalid Playwright instruction format")
app.domain.exceptions.StepGenerationException: Invalid Playwright instruction format

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/jaimeenrrique/Automation/WebOperatorFromTC/app/services/operator_runner.py", line 279, in _execute_single_step
    instruction_json = await self.playwright_generator.generate_instruction(
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jaimeenrrique/Automation/WebOperatorFromTC/app/infrastructure/ai_generators.py", line 178, in generate_instruction
    raise StepGenerationException(f"AI client error: {str(e)}") from e
app.domain.exceptions.StepGenerationException: AI client error: Invalid Playwright instruction format

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/jaimeenrrique/Automation/WebOperatorFromTC/app/services/operator_runner.py", line 345, in _execute_single_step
    playwright_instruction=instruction_json,  # Store the raw JSON for debugging
                           ^^^^^^^^^^^^^^^^
UnboundLocalError: cannot access local variable 'instruction_json' where it is not associated with a value
DEBUG    app.services.operator_runner:operator_runner.py:100 Stopping browser
DEBUG    app.services.operator_runner:operator_runner.py:107 Browser cleanup completed
---------------------------- Captured log teardown -----------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: KqueueSelector
=========================== short test summary info ============================
FAILED tests/integration/test_operator_runner.py::TestOperatorRunnerIntegration::test_google_search_flow
======================= 1 failed, 8 deselected in 28.07s =======================
